rule:
  meta:
    name: get session user name
    namespace: host-interaction/session
    authors:
      - "moritz.raabe@mandiant.com"
      - "anushka.virgaonkar@mandiant.com"
    scopes:
      static: function
      dynamic: process
    att&ck:
      - Discovery::System Owner/User Discovery [T1033]
      - Discovery::Account Discovery [T1087]
    examples:
      - Practical Malware Analysis Lab 14-01.exe_:0x401285
  features:
    - or:
      - api: advapi32.GetUserName
      - api: secur32.GetUserNameEx
      - or:
        - basic block:
          - and:
            - api: wtsapi32.WTSQuerySessionInformation
            - number: 5 = WTSUserName
        - thread:
          - and:
            - api: wtsapi32.WTSQuerySessionInformation
            - number: 5 = WTSUserName
      - api: System.Security.Principal.WindowsIdentity::GetCurrent
      - basic block:
        - and:
          - api: wtsapi32.WTSQuerySessionInformation
          - number: 5 = WTSUserName
      - property/read: System.Environment::UserName
