rule:
  meta:
    name: persist via Windows service
    namespace: persistence/service
    authors:
      - moritz.raabe@mandiant.com
    scopes:
      static: function
      dynamic: span of calls
    att&ck:
      - Persistence::Create or Modify System Process::Windows Service [T1543.003]
      - Execution::System Services::Service Execution [T1569.002]
    examples:
      - Practical Malware Analysis Lab 03-02.dll_:0x10004706
      - 9f012d7e3ae8f62370278e372691eb73b878fe2280b6083e1be637b278021855:0x40113A
features:
  or:
    # Strong indicator: service APIs
    - api: advapi32.CreateServiceA
    - api: advapi32.CreateServiceW
    - api: advapi32.ChangeServiceConfigA
    - api: advapi32.ChangeServiceConfigW
    - api: advapi32.CreateServiceExA
    - api: advapi32.CreateServiceExW

    # Registry-based persistence (tight, correct)
    - and:
      - match: host-interaction/registry/set-value
      - or:
        - string: /SYSTEM\\CurrentControlSet\\Services\\[^\\]+\\ImagePath/i
        - string: /SYSTEM\\CurrentControlSet\\Services\\[^\\]+\\Start(?![A-Za-z0-9_])/i
        - string: /SYSTEM\\CurrentControlSet\\Services\\[^\\]+\\Type(?![A-Za-z0-9_])/i
