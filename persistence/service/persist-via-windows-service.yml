features:
  or:
    # Strong indicator: service APIs
    - api: advapi32.CreateServiceA
    - api: advapi32.CreateServiceW
    - api: advapi32.ChangeServiceConfigA
    - api: advapi32.ChangeServiceConfigW
    - api: advapi32.CreateServiceExA
    
    - api: advapi32.CreateServiceExW

    # Original logic: service-create with SERVICE_AUTO_START / api patterns
    - and:
      - or:
        - and:
          - or:
            - basic block:
              - and:
                - number: 2 = SERVICE_AUTO_START
                - api: advapi32.CreateService
            - call:
              - and:
                - number: 2 = SERVICE_AUTO_START
                - api: advapi32.CreateService
          - optional:
            - or:
              - api: advapi32.OpenService
              - api: advapi32.StartService

    # Original logic: process/create invoking sc.exe or New-Service
    - and:
      - match: host-interaction/process/create
      - or:
        - and:
          - string: /^sc(|\.exe)$/i
          - string: /create /i
        - string: /^sc(|\.exe) create/i
        - string: /New-Service /i

    # Tight registry-based persistence: only ImagePath / Start / Type under Service keys
    - and:
      - match: host-interaction/registry/set-value
      - or:
        - string: /SYSTEM\\CurrentControlSet\\Services\\[^\\]+\\ImagePath/i
        - string: /SYSTEM\\CurrentControlSet\\Services\\[^\\]+\\Start(?![A-Za-z0-9_])/i
        - string: /SYSTEM\\CurrentControlSet\\Services\\[^\\]+\\Type(?![A-Za-z0-9_])/i
